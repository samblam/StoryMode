---
interface Props {
  surveyId: string;
}

const { surveyId } = Astro.props;
---

<div class="survey-preview">
  <button
    type="button"
    class="preview-button"
    data-survey-id={surveyId}
  >
    Preview Survey
  </button>
</div>

<script define:vars={{ surveyId }}>
  /**
   * Generate and open a preview of the survey
   * @param {string} surveyId - The ID of the survey to preview
   */
  async function previewSurvey(surveyId) {
    try {
      const button = document.querySelector(`.preview-button[data-survey-id="${surveyId}"]`);
      if (button) {
        button.disabled = true;
        button.textContent = 'Loading preview...';
      }

      // Get preview data
      const response = await fetch(`/api/surveys/${surveyId}/preview`);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || data.message || 'Failed to generate preview');
      }

      // Validate preview data
      if (!data || typeof data !== 'object') {
        throw new Error('Invalid preview data received');
      }

      // Open preview in new window/tab
      const previewUrl = `/surveys/${surveyId}?preview=true&context=${encodeURIComponent(JSON.stringify(data))}`;
      window.open(previewUrl, '_blank');
    } catch (error) {
      console.error('Error previewing survey:', error);
      alert(error.message || 'Failed to generate survey preview. Please try again.');
    } finally {
      // Re-enable button
      const button = document.querySelector(`.preview-button[data-survey-id="${surveyId}"]`);
      if (button) {
        button.disabled = false;
        button.textContent = 'Preview Survey';
      }
    }
  }

  // Add event listener to preview button
  function initializePreviewButton() {
    const button = document.querySelector(`.preview-button[data-survey-id="${surveyId}"]`);
    if (!button) {
      console.error('Preview button not found');
      return;
    }

    button.addEventListener('click', (e) => {
      e.preventDefault();
      const targetSurveyId = button.dataset.surveyId;
      if (targetSurveyId) {
        previewSurvey(targetSurveyId);
      } else {
        console.error('Survey ID not found on button');
      }
    });
  }

  // Initialize on page load and after client-side navigation
  document.addEventListener('astro:page-load', initializePreviewButton);
  initializePreviewButton();
</script>

<style>
  .survey-preview {
    margin: 1rem 0;
  }

  .preview-button {
    background-color: #4a5568;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    transition: background-color 0.2s, opacity 0.2s;
  }

  .preview-button:hover {
    background-color: #2d3748;
  }

  .preview-button:focus {
    outline: 2px solid #4299e1;
    outline-offset: 2px;
  }

  .preview-button:disabled {
    background-color: #cbd5e0;
    cursor: not-allowed;
    opacity: 0.7;
  }
</style>